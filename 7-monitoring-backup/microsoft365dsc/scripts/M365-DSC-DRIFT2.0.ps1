[CmdletBinding()]
param(
    [Parameter(Mandatory=$false)]
    [String]$Customer,
    
    [Parameter(Mandatory=$false)]
    [String]$PathCurrent,
    
    [Parameter(Mandatory=$false)]
    [String]$PathDrift,
    
    [Parameter(Mandatory=$false)]
    [String]$PathReport,
    
    [Parameter(Mandatory=$false)]
    [String]$TenantName,
    
    [Parameter(Mandatory=$false)]
    [String]$TenantId,
    
    [Parameter(Mandatory=$false)]
    [String]$WorkloadClientId,
    
    [Parameter(Mandatory=$false)]
    [String]$WorkloadThumbprint,
    
    [Parameter(Mandatory=$true)]
    [String]$EXOMailFrom,
    
    [Parameter(Mandatory=$true)]
    [String]$EXOMailTo,
    
    [Parameter(Mandatory=$true)]
    [String]$EXOClientId,
    
    [Parameter(Mandatory=$false)]
    [String]$EXOThumbprint,
    
    [Parameter(Mandatory=$false)]
    [String]$Workload
)

# Define workload components
$WorkloadComponents = @{
    "EntraID" = @("AADAccessReviewDefinition", "AADAccessReviewPolicy", "AADActivityBasedTimeoutPolicy", "AADAdminConsentRequestPolicy", "AADAdministrativeUnit", "AADAgreement", "AADAppManagementPolicy", "AADApplication", "AADAttributeSet", "AADAuthenticationContextClassReference", "AADAuthenticationFlowPolicy", "AADAuthenticationMethodPolicy", "AADAuthenticationMethodPolicyAuthenticator", "AADAuthenticationMethodPolicyEmail", "AADAuthenticationMethodPolicyExternal", "AADAuthenticationMethodPolicyFido2", "AADAuthenticationMethodPolicyHardware", "AADAuthenticationMethodPolicyQRCodeImage", "AADAuthenticationMethodPolicySms", "AADAuthenticationMethodPolicySoftware", "AADAuthenticationMethodPolicyTemporary", "AADAuthenticationMethodPolicyVoice", "AADAuthenticationMethodPolicyX509", "AADAuthenticationRequirement", "AADAuthenticationStrengthPolicy", "AADAuthorizationPolicy", "AADB2CAuthenticationMethodsPolicy", "AADClaimsMappingPolicy", "AADConditionalAccessPolicy", "AADConnectorGroupApplicationProxy", "AADCrossTenantAccessPolicy", "AADCrossTenantAccessPolicyConfigurationDefault", "AADCrossTenantAccessPolicyConfigurationPartner", "AADCrossTenantIdentitySyncPolicyPartner", "AADCustomAuthenticationExtension", "AADCustomSecurityAttributeDefinition", "AADDeviceRegistrationPolicy", "AADDomain", "AADEntitlementManagementAccessPackage", "AADEntitlementManagementAccessPackageAssignmentPolicy", "AADEntitlementManagementAccessPackageCatalog", "AADEntitlementManagementAccessPackageCatalogResource", "AADEntitlementManagementConnectedOrganization", "AADEntitlementManagementRoleAssignment", "AADEntitlementManagementSettings", "AADExternalIdentityPolicy", "AADFeatureRolloutPolicy", "AADFederationConfiguration", "AADFilteringPolicy", "AADFilteringPolicyRule", "AADFilteringProfile", "AADGroup", "AADGroupEligibilitySchedule", "AADGroupEligibilityScheduleSettings", "AADGroupLifecyclePolicy", "AADGroupsNamingPolicy", "AADGroupsSettings", "AADHomeRealmDiscoveryPolicy", "AADIdentityAPIConnector", "AADIdentityB2XUserFlow", "AADIdentityGovernanceLifecycleWorkflow", "AADIdentityGovernanceLifecycleWorkflowCustomTaskExtension", "AADIdentityGovernanceProgram", "AADIdentityProtectionPolicySettings", "AADLifecycleWorkflowSettings", "AADMultiTenantOrganizationIdentitySyncPolicyTemplate", "AADNamedLocationPolicy", "AADNetworkAccessForwardingPolicy", "AADNetworkAccessForwardingProfile", "AADNetworkAccessSettingConditionalAccess", "AADNetworkAccessSettingCrossTenantAccess", "AADOnPremisesPublishingProfilesSettings", "AADOrganizationCertificateBasedAuthConfiguration", "AADPIMGroupSetting", "AADPasswordRuleSettings", "AADRemoteNetwork", "AADRoleAssignmentScheduleRequest", "AADRoleDefinition", "AADRoleEligibilityScheduleRequest", "AADRoleManagementPolicyRule", "AADRoleSetting", "AADSecurityDefaults", "AADServicePrincipal", "AADSocialIdentityProvider", "AADTenantAppManagementPolicy", "AADTenantDetails", "AADTokenIssuancePolicy", "AADTokenLifetimePolicy", "AADUser", "AADUserFlowAttribute", "AADVerifiedIdAuthority", "AADVerifiedIdAuthorityContract", "ADOOrganizationOwner", "ADOPermissionGroup", "ADOPermissionGroupSettings", "ADOSecurityPolicy")
	
    "Exchange" = @("EXOATPBuiltInProtectionRule", "EXOAcceptedDomain", "EXOActiveSyncDeviceAccessRule", "EXOActiveSyncMailboxPolicy", "EXOAddressBookPolicy", "EXOAddressList", "EXOAntiPhishPolicy", "EXOAntiPhishRule", "EXOApplicationAccessPolicy", "EXOArcConfig", "EXOAtpPolicyForO365", "EXOAtpProtectionPolicyRule", "EXOAuthenticationPolicy", "EXOAuthenticationPolicyAssignment", "EXOAvailabilityAddressSpace", "EXOAvailabilityConfig", "EXOCASMailboxPlan", "EXOCASMailboxSettings", "EXOCalendarProcessing", "EXODataAtRestEncryptionPolicy", "EXODataAtRestEncryptionPolicyAssignment", "EXODataClassification", "EXODataEncryptionPolicy", "EXODistributionGroup", "EXODkimSigningConfig", "EXODnssecForVerifiedDomain", "EXOEOPProtectionPolicyRule", "EXOEmailAddressPolicy", "EXOEmailTenantSettings", "EXOExternalInOutlook", "EXOFocusedInbox", "EXOGlobalAddressList", "EXOGroupSettings", "EXOHostedConnectionFilterPolicy", "EXOHostedContentFilterPolicy", "EXOHostedContentFilterRule", "EXOHostedOutboundSpamFilterPolicy", "EXOHostedOutboundSpamFilterRule", "EXOIRMConfiguration", "EXOInboundConnector", "EXOIntraOrganizationConnector", "EXOJournalRule", "EXOMailContact", "EXOMailboxAuditBypassAssociation", "EXOMailboxAutoReplyConfiguration", "EXOMailboxCalendarConfiguration", "EXOMailboxCalendarFolder", "EXOMailboxFolderPermission", "EXOMailboxIRMAccess", "EXOMailboxPermission", "EXOMailboxPlan", "EXOMailboxSettings", "EXOMalwareFilterPolicy", "EXOMalwareFilterRule", "EXOManagementRole", "EXOManagementRoleAssignment", "EXOManagementRoleEntry", "EXOManagementScope", "EXOMessageClassification", "EXOMigration", "EXOMigrationEndpoint", "EXOMobileDeviceMailboxPolicy", "EXOOMEConfiguration", "EXOOfflineAddressBook", "EXOOnPremisesOrganization", "EXOOrganizationConfig", "EXOOrganizationRelationship", "EXOOutboundConnector", "EXOOwaMailboxPolicy", "EXOPartnerApplication", "EXOPerimeterConfiguration", "EXOPhishSimOverrideRule", "EXOPlace", "EXOPolicyTipConfig", "EXOQuarantinePolicy", "EXORecipientPermission", "EXORemoteDomain", "EXOReportSubmissionPolicy", "EXOReportSubmissionRule", "EXOResourceConfiguration", "EXORetentionPolicy", "EXORetentionPolicyTag", "EXORoleAssignmentPolicy", "EXORoleGroup", "EXOSafeAttachmentPolicy", "EXOSafeAttachmentRule", "EXOSafeLinksPolicy", "EXOSafeLinksRule", "EXOSecOpsOverrideRule", "EXOServicePrincipal", "EXOSharedMailbox", "EXOSharingPolicy", "EXOSmtpDaneInbound", "EXOSweepRule", "EXOTeamsProtectionPolicy", "EXOTenantAllowBlockListItems", "EXOTenantAllowBlockListSpoofItems", "EXOTransportConfig", "EXOTransportRule")
	
    "Intune" = @("IntuneAccountProtectionLocalAdministratorPasswordSolutionPolicy", "IntuneAccountProtectionLocalUserGroupMembershipPolicy", "IntuneAccountProtectionPolicyWindows10", "IntuneAndroidManagedStoreAppConfiguration", "IntuneAntivirusExclusionsPolicyLinux", "IntuneAntivirusExclusionsPolicyMacOS", "IntuneAntivirusPolicyLinux", "IntuneAntivirusPolicyMacOS", "IntuneAntivirusPolicySecurityExperienceWindows10ConfigMgr", "IntuneAntivirusPolicyWindows10ConfigMgr", "IntuneAntivirusPolicyWindows10SettingCatalog", "IntuneAppAndBrowserIsolationPolicyWindows10", "IntuneAppAndBrowserIsolationPolicyWindows10ConfigMgr", "IntuneAppCategory", "IntuneAppConfigurationDevicePolicy", "IntuneAppConfigurationPolicy", "IntuneAppControlForBusinessPolicyWindows10", "IntuneAppProtectionPolicyAndroid", "IntuneAppProtectionPolicyiOS", "IntuneAppleMDMPushNotificationCertificate", "IntuneApplicationControlPolicyWindows10", "IntuneAttackSurfaceReductionRulesPolicyWindows10ConfigManager", "IntuneAzureNetworkConnectionWindows365", "IntuneCloudProvisioningPolicyWindows365", "IntuneDefenderGlobalExclusionsPolicyLinux", "IntuneDerivedCredential", "IntuneDeviceAndAppManagementAssignmentFilter", "IntuneDeviceCategory", "IntuneDeviceCleanupRuleV2", "IntuneDeviceComplianceNotificationMessageTemplate", "IntuneDeviceCompliancePolicyAndroidDeviceOwner", "IntuneDeviceCompliancePolicyAndroidWorkProfile", "IntuneDeviceCompliancePolicyMacOS", "IntuneDeviceCompliancePolicyWindows10", "IntuneDeviceCompliancePolicyiOs", "IntuneDeviceComplianceScriptLinux", "IntuneDeviceComplianceScriptWindows10", "IntuneDeviceConfigurationAdministrativeTemplatePolicyWindows10", "IntuneDeviceConfigurationCustomPolicyWindows10", "IntuneDeviceConfigurationCustomPolicyiOS", "IntuneDeviceConfigurationDefenderForEndpointOnboardingPolicyWindows10", "IntuneDeviceConfigurationDeliveryOptimizationPolicyWindows10", "IntuneDeviceConfigurationDeliveryOptimizationPolicyWindows10V2", "IntuneDeviceConfigurationDomainJoinPolicyWindows10", "IntuneDeviceConfigurationEmailProfilePolicyWindows10", "IntuneDeviceConfigurationEndpointProtectionPolicyWindows10", "IntuneDeviceConfigurationFirmwareInterfacePolicyWindows10", "IntuneDeviceConfigurationHealthMonitoringConfigurationPolicyWindows10", "IntuneDeviceConfigurationIdentityProtectionPolicyWindows10", "IntuneDeviceConfigurationImportedPfxCertificatePolicyWindows10", "IntuneDeviceConfigurationKioskPolicyWindows10", "IntuneDeviceConfigurationNetworkBoundaryPolicyWindows10", "IntuneDeviceConfigurationPkcsCertificatePolicyWindows10", "IntuneDeviceConfigurationPlatformScriptMacOS", "IntuneDeviceConfigurationPlatformScriptWindows", "IntuneDeviceConfigurationPolicyAndroidDeviceOwner", "IntuneDeviceConfigurationPolicyAndroidOpenSourceProject", "IntuneDeviceConfigurationPolicyAndroidWorkProfile", "IntuneDeviceConfigurationPolicyMacOS", "IntuneDeviceConfigurationPolicyWindows10", "IntuneDeviceConfigurationPolicyiOS", "IntuneDeviceConfigurationSCEPCertificatePolicyWindows10", "IntuneDeviceConfigurationSecureAssessmentPolicyWindows10", "IntuneDeviceConfigurationSharedMultiDevicePolicyWindows10", "IntuneDeviceConfigurationTrustedCertificatePolicyWindows10", "IntuneDeviceConfigurationVpnPolicyWindows10", "IntuneDeviceConfigurationWindowsTeamPolicyWindows10", "IntuneDeviceConfigurationWiredNetworkPolicyWindows10", "IntuneDeviceControlPolicyWindows10", "IntuneDeviceEnrollmentLimitRestriction", "IntuneDeviceEnrollmentPlatformRestriction", "IntuneDeviceEnrollmentStatusPageWindows10", "IntuneDeviceFeaturesConfigurationPolicyIOS", "IntuneDeviceManagementAndroidDeviceOwnerEnrollmentProfile", "IntuneDeviceManagementComplianceSettings", "IntuneDeviceManagementEnrollmentAndroidGooglePlay", "IntuneDeviceRemediation", "IntuneDiskEncryptionMacOS", "IntuneDiskEncryptionPDEPolicyWindows10", "IntuneDiskEncryptionWindows10", "IntuneEndpointDetectionAndResponsePolicyLinux", "IntuneEndpointDetectionAndResponsePolicyMacOS", "IntuneEndpointDetectionAndResponsePolicyWindows10", "IntuneEpmElevationRulesPolicyWindows10", "IntuneEpmElevationSettingsPolicyWindows10", "IntuneExploitProtectionPolicyWindows10SettingCatalog", "IntuneFirewallPolicyWindows10", "IntuneFirewallRulesHyperVPolicyWindows10", "IntuneFirewallRulesPolicyWindows10", "IntuneFirewallRulesPolicyWindows10ConfigMgr", "IntuneMobileAppsBuiltInStoreApp", "IntuneMobileAppsBundleMacOS", "IntuneMobileAppsDefenderForEndpointMacOS", "IntuneMobileAppsLobAppAndroid", "IntuneMobileAppsLobAppMsiWindows10", "IntuneMobileAppsLobAppWindows10", "IntuneMobileAppsLobAppiOS", "IntuneMobileAppsMacOSLobApp", "IntuneMobileAppsManagedGooglePlayApp", "IntuneMobileAppsMicrosoft365SuiteMacOS", "IntuneMobileAppsMicrosoftEdge", "IntuneMobileAppsMicrosoftStoreAppWindows10", "IntuneMobileAppsStoreApp", "IntuneMobileAppsSystemAppAndroid", "IntuneMobileAppsWebLink", "IntuneMobileAppsWin32AppWindows10", "IntuneMobileAppsWindowsOfficeSuiteApp", "IntuneMobileThreatDefenseConnector", "IntunePolicySets", "IntuneRoleAssignment", "IntuneRoleDefinition", "IntuneRoleScopeTag", "IntuneSecurityBaselineDefenderForEndpoint", "IntuneSecurityBaselineHoloLens2Advanced", "IntuneSecurityBaselineHoloLens2Standard", "IntuneSecurityBaselineMicrosoft365AppsForEnterprise", "IntuneSecurityBaselineMicrosoftEdge", "IntuneSecurityBaselineWindows10", "IntuneSecurityBaselineWindows365", "IntuneSettingCatalogASRRulesPolicyWindows10", "IntuneSettingCatalogCustomPolicyWindows10", "IntuneTrustedRootCertificateAndroidDeviceOwner", "IntuneTrustedRootCertificateAndroidWork", "IntuneTrustedRootCertificateIOS", "IntuneUserSettingsPolicyWindows365", "IntuneVPNConfigurationPolicyAndroidDeviceOwner", "IntuneVPNConfigurationPolicyAndroidWork", "IntuneVPNConfigurationPolicyIOS", "IntuneWifiConfigurationPolicyAndroidEnterpriseDeviceOwner", "IntuneWifiConfigurationPolicyAndroidEnterpriseWorkProfile", "IntuneWifiConfigurationPolicyAndroidForWork", "IntuneWifiConfigurationPolicyAndroidOpenSourceProject", "IntuneWifiConfigurationPolicyIOS", "IntuneWifiConfigurationPolicyMacOS", "IntuneWifiConfigurationPolicyWindows10", "IntuneWindowsAutopilotDeploymentProfileAzureADHybridJoined", "IntuneWindowsAutopilotDeploymentProfileAzureADJoined", "IntuneWindowsBackupForOrganizationConfiguration", "IntuneWindowsHelloForBusinessGlobalPolicy", "IntuneWindowsInformationProtectionPolicyWindows10MdmEnrolled")
	
    "SharePoint" = @("O365AdminAuditLogConfig", "O365ExternalConnection", "O365Group", "O365OrgCustomizationSetting", "O365OrgSettings", "O365SearchAndIntelligenceConfigurations", "ODSettings", "SHSpaceGroup", "SHSpaceUser", "SPOAccessControlSettings", "SPOApp", "SPOBrowserIdleSignout", "SPOHomeSite", "SPOHubSite", "SPOOrgAssetsLibrary", "SPOPropertyBag", "SPORetentionLabelsSettings", "SPOSearchManagedProperty", "SPOSearchResultSource", "SPOSharingSettings", "SPOSite", "SPOSiteAuditSettings", "SPOSiteDesign", "SPOSiteDesignRights", "SPOSiteGroup", "SPOSiteScript", "SPOStorageEntity", "SPOTenantCdnEnabled", "SPOTenantCdnPolicy", "SPOTenantSettings", "SPOTheme", "SPOUserProfileProperty")
	
    "Compliance" = @("SCAuditConfigurationPolicy", "SCAutoSensitivityLabelPolicy", "SCAutoSensitivityLabelRule", "SCCaseHoldPolicy", "SCCaseHoldRule", "SCComplianceCase", "SCComplianceSearch", "SCComplianceSearchAction", "SCComplianceTag", "SCDLPCompliancePolicy", "SCDLPComplianceRule", "SCDeviceConditionalAccessPolicy", "SCDeviceConditionalAccessRule", "SCDeviceConfigurationPolicy", "SCDeviceConfigurationRule", "SCFilePlanPropertyAuthority", "SCFilePlanPropertyCategory", "SCFilePlanPropertyCitation", "SCFilePlanPropertyDepartment", "SCFilePlanPropertyReferenceId", "SCFilePlanPropertySubCategory", "SCInsiderRiskEntityList", "SCInsiderRiskPolicy", "SCLabelPolicy", "SCPolicyConfig", "SCProtectionAlert", "SCRecordReviewNotificationTemplateConfig", "SCRetentionCompliancePolicy", "SCRetentionComplianceRule", "SCRetentionEventType", "SCRoleGroup", "SCRoleGroupMember", "SCSecurityFilter", "SCSensitivityLabel", "SCSupervisoryReviewPolicy", "SCSupervisoryReviewRule", "SCUnifiedAuditLogRetentionPolicy")
	
    "Teams" = @("PlannerBucket", "PlannerPlan", "PlannerTask", "TeamsAppPermissionPolicy", "TeamsAppSetupPolicy", "TeamsApplicationInstance", "TeamsAudioConferencingPolicy", "TeamsCallHoldPolicy", "TeamsCallParkPolicy", "TeamsCallQueue", "TeamsCallingPolicy", "TeamsChannel", "TeamsChannelsPolicy", "TeamsClientConfiguration", "TeamsComplianceRecordingPolicy", "TeamsCortanaPolicy", "TeamsDialInConferencingTenantSettings", "TeamsEmergencyCallRoutingPolicy", "TeamsEmergencyCallingPolicy", "TeamsEnhancedEncryptionPolicy", "TeamsEventsPolicy", "TeamsFederationConfiguration", "TeamsFeedbackPolicy", "TeamsFilesPolicy", "TeamsGroupPolicyAssignment", "TeamsGuestCallingConfiguration", "TeamsGuestMeetingConfiguration", "TeamsGuestMessagingConfiguration", "TeamsIPPhonePolicy", "TeamsM365App", "TeamsMeetingBroadcastConfiguration", "TeamsMeetingBroadcastPolicy", "TeamsMeetingConfiguration", "TeamsMeetingPolicy", "TeamsMessagingConfiguration", "TeamsMessagingPolicy", "TeamsMobilityPolicy", "TeamsNetworkRoamingPolicy", "TeamsOnlineVoiceUser", "TeamsOnlineVoicemailPolicy", "TeamsOnlineVoicemailUserSettings", "TeamsOrgWideAppSettings", "TeamsPstnUsage", "TeamsShiftsPolicy", "TeamsTeam", "TeamsTemplatesPolicy", "TeamsTenantDialPlan", "TeamsTenantNetworkRegion", "TeamsTenantNetworkSite", "TeamsTenantNetworkSubnet", "TeamsTenantTrustedIPAddress", "TeamsTranslationRule", "TeamsUnassignedNumberTreatment", "TeamsUpdateManagementPolicy", "TeamsUpgradeConfiguration", "TeamsUpgradePolicy", "TeamsUser", "TeamsUserCallingSettings", "TeamsUserPolicyAssignment", "TeamsVdiPolicy", "TeamsVoiceRoute", "TeamsVoiceRoutingPolicy", "TeamsWorkloadPolicy", "VivaEngagementRoleMember")
}

$SelectedComponents = if ($Workload -and $WorkloadComponents.ContainsKey($Workload)) {
    $WorkloadComponents[$Workload]
} else {
    $WorkloadComponents.Values | ForEach-Object { $_ }
}

Export-M365DSCConfiguration -Components $SelectedComponents -ApplicationId $WorkloadClientId -CertificateThumbprint $WorkloadThumbprint -TenantId $TenantName -Path $PathDrift

# New-M365DSCDeltaReport -Source "$PathCurrent\M365TenantConfig.ps1" -Destination "$PathDrift\M365TenantConfig.ps1" -OutputPath "$PathReport\$TenantName-DeltaReport-M365-$Workload.html"
New-M365DSCDeltaReport -Source "$PathCurrent\M365TenantConfig.ps1" -Destination "$PathDrift\M365TenantConfig.ps1" -Type JSON -OutputPath "$PathReport\$TenantName-DriftReport-M365-$Workload.json"

# Disconnect from Microsoft Graph for email operations
# Disconnect-MgGraph

Write-Verbose "Email sent successfully"